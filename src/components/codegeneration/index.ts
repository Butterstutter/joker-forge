import { JokerData } from "../JokerCard";
import JSZip from "jszip";
import { addAtlasToZip } from "./ImageProcessor";
import {
  generateJokerBaseCode,
  generateBasicLocVarsFunction,
  generateBasicCalculateFunction,
} from "./JokerBase";
import { generatePokerHandCode } from "./effects/PokerHandEffects";

import { generateSuitCardCode } from "./effects/SuitCardEffects";

export const exportJokersAsMod = async (
  jokers: JokerData[],
  modName: string,
  authorName: string
): Promise<boolean> => {
  try {
    const zip = new JSZip();
    const modId = modName.toLowerCase().replace(/\s+/g, "");

    zip.file("main.lua", generateMainLua(jokers));
    zip.file(`${modId}.json`, generateModJson(modName, modId, authorName));
    zip.file("config.lua", "return {}");

    await addAtlasToZip(zip, jokers);

    const content = await zip.generateAsync({ type: "blob" });
    const url = URL.createObjectURL(content);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${modId}.zip`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    return true;
  } catch (error) {
    console.error("Failed to generate mod:", error);
    return false;
  }
};

const generateMainLua = (jokers: JokerData[]): string => {
  let output = `local mod = SMODS.current_mod
-- FILE GENERATED BY JOKER FORGE

mod.config = {}

-- Create custom joker atlas
SMODS.Atlas({
    key = "CustomJokers", 
    path = "CustomJokers.png", 
    px = 71,
    py = 95, 
    atlas_table = "ASSET_ATLAS"
}):register()

`;

  jokers.forEach((joker, index) => {
    output += generateJokerCode(joker, index, "CustomJokers") + "\n\n";
  });

  output += "return mod";
  return output;
};

const generateJokerCode = (
  joker: JokerData,
  index: number,
  atlasKey: string
): string => {
  console.log(`Generating code for joker: ${joker.name}`);

  // Start with the base joker code
  let jokerCode = generateJokerBaseCode(joker, index, atlasKey);
  let locVarsCode = "";
  let calculateCode = "";

  if (joker.rules && joker.rules.length > 0) {
    console.log(`Joker has ${joker.rules.length} rules`);

    // First check for suit rules - look for card_suit conditions (PRIORITIZE THIS)
    const suitRules = joker.rules.filter((rule) => {
      return rule.conditionGroups.some((group) =>
        group.conditions.some((condition) => condition.type === "card_suit")
      );
    });
    console.log(`Found ${suitRules.length} suit rules`);

    // Then check for poker hand rules (only if no suit rules)
    const pokerHandRules =
      suitRules.length === 0
        ? joker.rules.filter((rule) => rule.trigger === "poker_hand_played")
        : [];
    console.log(`Found ${pokerHandRules.length} poker hand rules`);

    // Log the first suit rule structure for debugging
    if (suitRules.length > 0) {
      console.log("First suit rule:", JSON.stringify(suitRules[0], null, 2));
    }

    if (suitRules.length > 0) {
      // Generate specialized code for suit rules
      console.log("Generating code for suit rules");
      locVarsCode = generateBasicLocVarsFunction(joker);
      calculateCode = generateSuitCardCode(joker, suitRules);
      console.log(`Generated calculate code length: ${calculateCode.length}`);

      // Fallback if no code was generated
      if (!calculateCode || calculateCode.trim() === "") {
        console.warn(
          "No calculate code generated for suit rules, using fallback"
        );
        calculateCode = generateBasicCalculateFunction(joker);
      }
    } else if (pokerHandRules.length > 0) {
      // Generate specialized code for poker hand rules
      console.log("Generating code for poker hand rules");
      locVarsCode = generateBasicLocVarsFunction(joker);
      calculateCode = generatePokerHandCode(joker, pokerHandRules);
      console.log(`Generated calculate code length: ${calculateCode.length}`);

      // Fallback if no code was generated
      if (!calculateCode || calculateCode.trim() === "") {
        console.warn(
          "No calculate code generated for poker hand rules, using fallback"
        );
        calculateCode = generateBasicCalculateFunction(joker);
      }
    } else {
      // Standard code for other rules or no rules
      console.log("Generating basic calculate function");
      locVarsCode = generateBasicLocVarsFunction(joker);
      calculateCode = generateBasicCalculateFunction(joker);
    }
  } else {
    // No rules
    console.log("No rules - generating basic calculate function");
    locVarsCode = generateBasicLocVarsFunction(joker);
    calculateCode = generateBasicCalculateFunction(joker);
  }

  // Add the generated code to the joker
  jokerCode += `,

    ${locVarsCode},

    ${calculateCode}
}`;

  return jokerCode;
};

const generateModJson = (
  modName: string,
  modId: string,
  authorName: string
): string => {
  const metadata = {
    id: modId,
    name: modName,
    display_name: modName,
    author: [authorName],
    description: "Custom jokers created with Joker Forge",
    prefix: modId,
    main_file: "main.lua",
    priority: 1,
    version: "1.0.0",
    dependencies: ["Steamodded (>=1.0.0~BETA-0404a)"],
  };

  return JSON.stringify(metadata, null, 2);
};
